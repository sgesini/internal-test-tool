<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dalenys – S2S Maintenance</title>
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <!-- ======= HEADER ======= -->
  <header id="main-header">
    <div id="top-left-corner">
      <a href="../index.html" class="back-home-btn">← Home page</a>
    </div>

    <div class="theme-switch-wrapper">
      <span class="theme-label">Light Mode </span>
      <label class="theme-switch" for="theme-toggle">
        <input type="checkbox" id="theme-toggle" />
        <span class="slider round"></span>
      </label>
      <span class="theme-label">Dark Mode</span>
    </div>
  </header>

  <!-- ======= CONTENU PRINCIPAL ======= -->
  <div id="payment-wrapper">
    <form id="s2s-form" class="panel">
      <h3>S2S Maintenance Operations</h3>

      <!-- Method / Operation -->
      <div class="form-group">
        <label for="method">Operation Type</label>
        <select id="method" name="method" required>
          <option value="">Select...</option>
          <option value="capture">Capture</option>
          <option value="refund">Refund</option>
          <option value="void">Void</option>
        </select>
      </div>

      <!-- Transaction ID -->
      <div class="form-group">
        <label for="transactionid">Transaction ID</label>
        <input type="text" id="transactionid" name="TRANSACTIONID" placeholder="Enter transaction ID" required />
      </div>

      <!-- Hidden Fields -->
      <input type="hidden" id="identifier" name="IDENTIFIER" />
      <input type="hidden" id="operationtype" name="OPERATIONTYPE" />
      <input type="hidden" id="orderid" name="ORDERID" />
      <input type="hidden" id="description" name="DESCRIPTION" value="Knows nothing" />
      <input type="hidden" id="version" name="VERSION" value="3.0" />

      <p class="submit">
        <input type="submit" value="Send Maintenance Request" class="primary" />
      </p>
    </form>

    <!-- ======= Panneau Environnements ======= -->
    <div id="env-panel" class="panel">
      <h3>Environments</h3>
      <label for="env-select">Choose an environment :</label>
      <select id="env-select">
        <option value="">-- Choose --</option>
        <option value="new">+ New environment</option>
      </select>
      <label>Name :</label>
      <input type="text" id="env-name" placeholder="Environment name" />
      <label>Public Key ID :</label>
      <input type="text" id="env-public-key-id" placeholder="ex: key_sandbox_123" />
      <label>Public Key :</label>
      <input type="text" id="env-public-key" placeholder="ex: pk_live_abc" />
      <label>Identifier :</label>
      <input type="text" id="env-identifier" placeholder="ex: IDENTIFIER_123" />
      <label>Secret Key :</label>
      <input type="text" id="env-secret-key" placeholder="Secret Key" />
      <button id="use-env" class="primary">Use</button>
      <button id="delete-env" class="danger">Delete</button>
    </div>
  </div>

  <!-- ======= Scripts ======= -->
  <script src="../js/env-manager.js"></script>
  <script src="../js/use-case-selection.js"></script>
  <script src="../js/extra-params.js"></script>
  <script src="../js/payment-utils.js"></script>
  <script src="../js/form-handler.js"></script>
  <script src="../js/script.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Récupération de l'environnement courant
      const lastEnv = localStorage.getItem("lastEnv");
      if (lastEnv) {
        fetch(`/api/env/${encodeURIComponent(lastEnv)}`)
          .then(r => r.json())
          .then(env => {
            if (env?.identifier) {
              document.getElementById("identifier").value = env.identifier;
            }
          });
      }

      // Génération automatique du ORDERID
      document.getElementById("orderid").value = PaymentUtils.generateOrderId();

      // Synchronisation method / operationtype
      const methodSelect = document.getElementById("method");
      methodSelect.addEventListener("change", (e) => {
        document.getElementById("operationtype").value = e.target.value;
      });

      // Envoi du formulaire via le form-handler
      document.getElementById("maintenance-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = {
          method: methodSelect.value,
          IDENTIFIER: document.getElementById("identifier").value,
          OPERATIONTYPE: document.getElementById("operationtype").value,
          TRANSACTIONID: document.getElementById("transactionid").value,
          ORDERID: document.getElementById("orderid").value,
          DESCRIPTION: document.getElementById("description").value,
          VERSION: document.getElementById("version").value,
          type: "s2s-maintenance"
        };

        await handleFormSubmission(data);
      });
    });
  </script>
</body>
</html>
